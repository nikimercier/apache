<!DOCTYPE html>
<html lang="en">
<head>
    <title>dc.js - Bar Chart Example</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
</head>
<body>

<div class="container">
<script type="text/javascript" src="header.js"></script>
<div id="test"></div>
<div id="test2"></div>

<script type="text/javascript" src="../js/d3.js"></script>
<script type="text/javascript" src="../js/crossfilter.js"></script>
<script type="text/javascript" src="../js/dc.js"></script>
<script type="text/javascript">

var chart = dc.barChart("#test");
var chart2 = dc.barChart("#test2");
  d3.csv("double-group.csv", function(error, experiments) {
      var dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S.%L");
  experiments.forEach(function(x) {
    x.dd = dateFormat.parse(x.created_time);
  });

  var ndx                 = crossfilter(experiments),
      moveTime = ndx.dimension(function (d) {return d.dd;}),
      timeGroup = moveTime.group().reduceCount(function (d) { return d.mac_add;});

  chart
    .width(768)
    .height(250)
    .x(d3.time.scale().domain([new Date(2016, 11, 7), new Date(2016, 11, 8)]))
    .dimension(moveTime)
                .group(timeGroup)
                .centerBar(true)
                .gap(1)
                .elasticY(true)
                .round(d3.time.minute.round)
                .xUnits(d3.time.minute);
    chart.render();
//##################################################################################


var maDim = ndx.dimension(function (d) {
  return d.mac_add;
});

var maGroup = maDim.group();

function bin_keys_by_value(group, bin_value) {
  var _bins;
  return {
    all: function () {
      var bins = {};
      group.all().forEach(function (kv) {
        var valk = bin_value(kv.value);
        bins[valk] = bins[valk] || [];
        bins[valk].push(kv.key);                                
      });
      _bins = bins;
      // note: Object.keys returning numerical order here might not
      // work everywhere, but I couldn't find a browser where it didn't
      return Object.keys(bins).map(function (bin) {
        return { key: bin, value: bins[bin].length };
      })
    },
    bins: function () {
      return _bins;
    }
  };
}

var bin_30_mins = function(v) {
  return 30 * Math.ceil(v/30);
}

var macsPerMinuteCount = bin_keys_by_value(maGroup, bin_30_mins);

      chart2
          .width(768)
          .height(250)
          .x(d3.scale.linear().domain([60,1440]))
          .xUnits(function(start, end) {
              return (end-start)/30;
          })
          .dimension(maDim)
          .group(macsPerMinuteCount)
          .gap(1)
          .elasticY(true);
      chart2.render();
});

</script>

</div>
</body>
</html>
